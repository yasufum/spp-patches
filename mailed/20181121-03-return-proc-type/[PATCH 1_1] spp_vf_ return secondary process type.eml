X-Account-Key: account4
X-UIDL: 0000889056a584ea
X-Mozilla-Status: 0001
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                 
Return-Path: <x-fn-spp@sl.ntt-tx.co.jp>
X-Original-To: yo128@mail2.ecl.ntt.co.jp
Delivered-To: yo128@mail2.ecl.ntt.co.jp
Received: from dmail1.ecl.ntt.co.jp (dmail1.ecl.ntt.co.jp [129.60.86.151])
	by jcms-pop21.ecl.ntt.co.jp (Postfix) with ESMTP id B5FB4400870
	for <yo128@mail2.ecl.ntt.co.jp>; Wed, 21 Nov 2018 10:42:30 +0900 (JST)
Received: by dmail1.ecl.ntt.co.jp (Postfix)
	id B431623BAE6; Wed, 21 Nov 2018 10:42:30 +0900 (JST)
Delivered-To: ogawa.yasufumi@lab.ntt.co.jp
Received: from vc1.ecl.ntt.co.jp (vc1.ecl.ntt.co.jp [129.60.86.153])
	by dmail1.ecl.ntt.co.jp (Postfix) with ESMTP id B374F23B857
	for <ogawa.yasufumi@lab.ntt.co.jp>; Wed, 21 Nov 2018 10:42:30 +0900 (JST)
Received: from vc1.ecl.ntt.co.jp (localhost [127.0.0.1])
	by vc1.ecl.ntt.co.jp (Postfix) with ESMTP id A7189EA7723
	for <ogawa.yasufumi@lab.ntt.co.jp>; Wed, 21 Nov 2018 10:42:30 +0900 (JST)
Received: from dcma-spm01.ecl.ntt.co.jp (unknown [129.60.87.149])
	by vc1.ecl.ntt.co.jp (Postfix) with ESMTP id 9B859EA7711
	for <ogawa.yasufumi@lab.ntt.co.jp>; Wed, 21 Nov 2018 10:42:30 +0900 (JST)
Authentication-Results: dcma-spm01.ecl.ntt.co.jp; spf=Pass smtp.pra=x-fn-spp@sl.ntt-tx.co.jp; spf=Pass smtp.mailfrom=x-fn-spp@sl.ntt-tx.co.jp
Received-SPF: Pass (dcma-spm01.ecl.ntt.co.jp: domain of
  x-fn-spp@sl.ntt-tx.co.jp designates 210.232.35.69 as
  permitted sender) identity=pra; client-ip=210.232.35.69;
  receiver=dcma-spm01.ecl.ntt.co.jp;
  envelope-from="x-fn-spp@sl.ntt-tx.co.jp";
  x-sender="x-fn-spp@sl.ntt-tx.co.jp";
  x-conformance=sidf_strict; x-record-type="v=spf1";
  x-record-text="v=spf1 a:mail03.ics.ntt-tx.co.jp
  a:mail04.ics.ntt-tx.co.jp a:mail05.ics.ntt-tx.co.jp
  a:mail06.ics.ntt-tx.co.jp a:mail07.ics.ntt-tx.co.jp
  a:mail08.ics.ntt-tx.co.jp ip4:210.232.35.195
  ip4:210.232.35.196 ip4:210.232.35.65 ip4:210.232.35.66 ~all"
Received-SPF: Pass (dcma-spm01.ecl.ntt.co.jp: domain of
  x-fn-spp@sl.ntt-tx.co.jp designates 210.232.35.69 as
  permitted sender) identity=mailfrom; client-ip=210.232.35.69;
  receiver=dcma-spm01.ecl.ntt.co.jp;
  envelope-from="x-fn-spp@sl.ntt-tx.co.jp";
  x-sender="x-fn-spp@sl.ntt-tx.co.jp";
  x-conformance=sidf_strict; x-record-type="v=spf1";
  x-record-text="v=spf1 a:mail03.ics.ntt-tx.co.jp
  a:mail04.ics.ntt-tx.co.jp a:mail05.ics.ntt-tx.co.jp
  a:mail06.ics.ntt-tx.co.jp a:mail07.ics.ntt-tx.co.jp
  a:mail08.ics.ntt-tx.co.jp ip4:210.232.35.195
  ip4:210.232.35.196 ip4:210.232.35.65 ip4:210.232.35.66 ~all"
IronPort-PHdr: =?us-ascii?q?9a23=3AsF7m6hMeSb8geq8/zg0l6mtXPHoOpqn0MwgJ65?=
 =?us-ascii?q?Eul7NJdOGZ8o//OFDEvKwy3lPCWIye8OpB07OQvqvkH2oc/dCKtzYAaM8ETA?=
 =?us-ascii?q?cL3P0fhBdoG8uZEQvjNve/f2k0GoFZTEdN5HX9N1RJXdruIVbV5H+qvnYJAh?=
 =?us-ascii?q?uqDQNuPazuH5LKycG+1uS84ZrWNhUNijz4eqtqBA6y6wPNqowKkc1pLeAz0k?=
 =?us-ascii?q?KT8EFFcOlX225kYGmrsUikuZWI9YV4u2RcsPcostVYVP2jOakzSfpeEChgOG?=
 =?us-ascii?q?dz5tW5/RXESAKO4DMbXAB02lJYRgbDqQriRr/qtm38qvY4xDncNsqwT6h8VT?=
 =?us-ascii?q?m57qhtQQPlk29dbmZ/qjqNzJctyvwK6Bu6wn43i5bZeoSUKOZzcuvGcNUWSH?=
 =?us-ascii?q?AAFsddWipdA5+tOpMVBrlJNuJZoo/h4loW+EHnXU/2X7mpkWIO2C6luM9ym/?=
 =?us-ascii?q?4sGgzHwgE6St4FtX2Rt83wbP5UXOuxiq/U0XPIaLVUwWSYisCAfxY/rPWLRb?=
 =?us-ascii?q?81f9DWzBxlB0bLiBCLsZTNJDfT0PgR9nSLqeFnE+C3wT1CyUk5sn20y8Egh5?=
 =?us-ascii?q?OczJJQxFaB7j1h6J0xY9ukVAtncZivF91Sr2vJUuk+CtNnSGZutiEgz7QAsp?=
 =?us-ascii?q?PuZykGxqM82wTeYODUO5jN+B/oU/ydZCtpnH8wMqzqnA68qALzr4+0Htnxyl?=
 =?us-ascii?q?tBqTBJ18XBpmxYnQKG8dCJE7N0rEKo2DLXjEbS4foCJ1wo0LbLbZUmhLwo8/?=
 =?us-ascii?q?hb+U2RGyb3nB2qyq6dbQMi5vTt9/ShabKgpIfUPt1xgwD6avlom8ekR+IkLk?=
 =?us-ascii?q?0STy6Q/qK+zNiBtQXwErBDj/luzO/Yu4ucI9gH47KpRQRSlIQ7ox/tCj6n1I?=
 =?us-ascii?q?xH23gMNxRDZA7Ck5ivMFaIIuidb7/3igapmTZvn6CAP7b6RJPRMj3fgPHqev?=
 =?us-ascii?q?B/8wZd0FZhl4kHocgPUPdafbSqCxKU1pSQDwdlYVbtm6C9U487jd5YADPRSq?=
 =?us-ascii?q?6BbPGI6AfOvLl1ZbLRItFI8Dfld6p/vqao1yRj3wRAO/f3lY0ebHTyR640GU?=
 =?us-ascii?q?iSbHvyj9tEKl8k4FNkHtTjk0bKETJYYn/3RLo5vmh9BYmiS4HfWsamh/qDxH?=
 =?us-ascii?q?XzEppTb2FAQleCdBWgP5XBVfFJczqKCtRl1DoYSf29W8kq0lesrEf2xqFmIe?=
 =?us-ascii?q?zd5iAD/ci6jJ4vvLeVzkx0q208Bt/4sSnFV2xum2IUWzI6lLtyp0Bw0BbL0K?=
 =?us-ascii?q?R1heBZCc0G4vpIVgkgMpuPh+d+Ct30RkfAZoLTEQ7gGI78R2psCIxgkLpsKw?=
 =?us-ascii?q?5nFt6vjw7OxX+mCLoc0qeTAcRttK/X2z73O9o7wHGA1rFy6jtuCsZJK2Cigb?=
 =?us-ascii?q?ZysgbJAIuc2VXcmaDvbrwE9DXJsmGf0S+SrAdTV0hySe+WOBJXLluTttn/6k?=
 =?us-ascii?q?7YGvW+TLohdxBZ0eaZLu1MdsGskUUAT/ClOsyUMAfT0y+gQB2PwL2Ldo/jfW?=
 =?us-ascii?q?4QiT7cBEYziBwJ/H2aZkAuQz2sqGXEAHlyBEriNgnypPJmpirxHSpWh0maKl?=
 =?us-ascii?q?ds3L2v9lsJiOyAHrkNi6kctn5pomdxFVe5h4mQCtGb4Qx9YOBAcZU25xFFzQ?=
 =?us-ascii?q?e7/0R0bJmpLqQ62hgfeB8xuV/ykglnTI5H18oy5Hp4yQNzLfrFllJKbHWewY?=
 =?us-ascii?q?y1Jq2RIW60/gjKCeae0wPb2deSovlJ6f8j7VP/oES1Bgwp9DNly5FcgX6V55?=
 =?us-ascii?q?GSU0wTWom3VForsgRq4brdJCslguGcnXQ+NKC1tmeSndMiH60j1grlY8cZO6?=
 =?us-ascii?q?TCFhe6EtVGVZL3cKpwwALvNU9CZbEPkcx8d8K+K6ncgfbtZr062mn7yz0Wvs?=
 =?us-ascii?q?h8yh7erXMkDLSThdBenrfGg0OGT2uu1g759Jqsw8YfOHdMQCKpwCzgTtcANJ?=
 =?us-ascii?q?03Rp4CDCKVG+Pyw9x/g5D3XHsBqwy4AxUAxNPsZQrUZFu73xUCjB1L80zioj?=
 =?us-ascii?q?OxynlPqx9strCWhXOc2OCkcgYbf3JbAmJly1X0c9G5?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AEAACrt/Rbl0Uj6NJkGwEBAQEDAQE?=
 =?us-ascii?q?BBwMBAQGBUQYBAQELAYIAgTghAwcIJ4wQX6RkgXqEeTeDYQEFLwkNAQMBAQI?=
 =?us-ascii?q?BAQEBFAEBAQEBBhgGWIVqUjAMNE8SgyGCAaskM4h/gSyHWoFnhFqBEYdZIYV?=
 =?us-ascii?q?xAocWB4d3do9tCYolhwUYgViPKSyJPpADgg2BQIJsgicOCY4rMAEBATABizy?=
 =?us-ascii?q?CTQEB?=
X-SPF-Status: pass
Received: from mail05.ics.ntt-tx.co.jp (HELO mail04.ics.ntt-tx.co.jp) ([210.232.35.69])
  by dcma-spm01.ecl.ntt.co.jp with ESMTP; 21 Nov 2018 10:42:16 +0900
Received: from gwchk03.silk.ntt-tx.co.jp (gwchk03.silk.ntt-tx.co.jp [10.107.0.111])
	by mail04.ics.ntt-tx.co.jp (unknown) with ESMTP id wAL1gD2M003232;
	Wed, 21 Nov 2018 10:42:13 +0900
Received: (from root@localhost)
	by gwchk03.silk.ntt-tx.co.jp (unknown) id wAL1gDtJ005562;
	Wed, 21 Nov 2018 10:42:13 +0900
Received: from gwchk.silk.ntt-tx.co.jp [10.107.0.110] 
	 by gwchk03.silk.ntt-tx.co.jp with ESMTP id LAA02291;
	 Wed, 21 Nov 2018 10:36:30 +0900
Received: from imss03.silk.ntt-tx.co.jp (localhost [127.0.0.1]) by imss03.silk.ntt-tx.co.jp (unknown) with ESMTP id wAL1aUl1009822; Wed, 21 Nov 2018 10:36:30 +0900
Received: from mgate02.silk.ntt-tx.co.jp (smtp02.silk.ntt-tx.co.jp [10.107.0.37]) by imss03.silk.ntt-tx.co.jp (unknown) with ESMTP id wAL1aUGj009819; Wed, 21 Nov 2018 10:36:30 +0900
Message-Id: <201811210136.wAL1aUGj009819@imss03.silk.ntt-tx.co.jp>
Received: from localhost by mgate02.silk.ntt-tx.co.jp (unknown)
	id wAL1aTiA008462 ; Wed, 21 Nov 2018 10:36:29 +0900
From: x-fn-spp@sl.ntt-tx.co.jp
To: ferruh.yigit@intel.com, ogawa.yasufumi@lab.ntt.co.jp
Cc: spp@dpdk.org
Subject: [PATCH 1/1] spp_vf: return secondary process type
Date: Wed, 21 Nov 2018 10:36:29 +0900
X-Mailer: git-send-email 2.18.0
X-TM-AS-MML: disable

From: Hideyuki Yamashita <yamashita.hideyuki@po.ntt-tx.co.jp>

spp-ctl requires to be notified ID and type from secondary processes
while registering. This update is to change to return the secondary type
of `none`, `vf` or `mirror`.

Signed-off-by: Hideyuki Yamashita <yamashita.hideyuki@po.ntt-tx.co.jp>
Signed-off-by: Naoki Takada <takada.naoki@lab.ntt.co.jp>
---
 src/vf/common/command_proc.c | 34 ++++++++++++++++++++++++++++++++++
 src/vf/common/spp_proc.h     |  9 +++++++++
 src/vf/spp_vf.c              |  4 +++-
 3 files changed, 46 insertions(+), 1 deletion(-)

diff --git a/src/vf/common/command_proc.c b/src/vf/common/command_proc.c
index e6a9fab..cf35ce0 100644
--- a/src/vf/common/command_proc.c
+++ b/src/vf/common/command_proc.c
@@ -66,6 +66,18 @@ struct command_response_list {
 	int (*func)(const char *name, char **output, void *tmp);
 };
 
+/*
+ * seconary type string list
+ * do it same the order enum secondary_type (spp_proc.h)
+ */
+const char *SECONDARY_PROCESS_TYPE_SRINGS[] = {
+	"none",
+	"vf",
+	"mirror",
+
+	/* termination */ "",
+};
+
 /*
  * port ability string list
  * do it same as the order of enum spp_port_ability_type (spp_vf.h)
@@ -101,6 +113,17 @@ spp_get_client_id(void)
 	return startup_param->client_id;
 }
 
+/* get process type */
+static int
+spp_get_process_type(void)
+{
+	struct startup_param *startup_param;
+
+	spp_get_mng_data_addr(&startup_param,
+			NULL, NULL, NULL, NULL, NULL, NULL);
+	return startup_param->secondary_type;
+}
+
 /* Check if port has been flushed. */
 static int
 spp_check_flush_port(enum port_type iface_type, int iface_no)
@@ -886,6 +909,15 @@ append_interface_array(char **output, const enum port_type type)
 	return SPP_RET_OK;
 }
 
+/* append a secondary process type for JSON format */
+static int
+append_process_type_value(const char *name, char **output,
+		void *tmp __attribute__ ((unused)))
+{
+	return append_json_str_value(name, output,
+			SECONDARY_PROCESS_TYPE_SRINGS[spp_get_process_type()]);
+}
+
 /* append a list of interface numbers for JSON format */
 static int
 append_interface_value(const char *name, char **output,
@@ -1465,6 +1497,8 @@ send_command_result_response(int *sock,
 					"client id response.\n");
 			return;
 		}
+		ret = append_process_type_value("process_type",
+							&tmp_buff, NULL);
 	}
 
 	/* append info value */
diff --git a/src/vf/common/spp_proc.h b/src/vf/common/spp_proc.h
index 8bb43ec..4001c21 100644
--- a/src/vf/common/spp_proc.h
+++ b/src/vf/common/spp_proc.h
@@ -148,6 +148,13 @@ enum copy_mng_flg {
 	COPY_MNG_FLG_ALLCOPY,
 };
 
+/* secondary process type used only from spp_vf and spp_mirror */
+enum secondary_type {
+	SECONDARY_TYPE_NONE,
+	SECONDARY_TYPE_VF,
+	SECONDARY_TYPE_MIRROR,
+};
+
 /**
  * Interface information structure
  */
@@ -218,6 +225,8 @@ struct startup_param {
 				/* IP address stiring of spp-ctl */
 	int server_port;	/* Port Number of spp-ctl */
 	int vhost_client;	/* Flag for --vhost-client option */
+	enum secondary_type secondary_type;
+				/* secondary type */
 };
 
 /* Manage number of interfaces  and port information as global variable */
diff --git a/src/vf/spp_vf.c b/src/vf/spp_vf.c
index 7ceb88f..4e4a8e1 100644
--- a/src/vf/spp_vf.c
+++ b/src/vf/spp_vf.c
@@ -171,10 +171,12 @@ parse_app_args(int argc, char *argv[])
 		usage(progname);
 		return SPP_RET_NG;
 	}
+	g_startup_param.secondary_type = SECONDARY_TYPE_VF;
 	RTE_LOG(INFO, APP,
-			"app opts (client_id=%d,server=%s:%d,"
+			"app opts (client_id=%d,type=%d,server=%s:%d,"
 			"vhost_client=%d)\n",
 			g_startup_param.client_id,
+			g_startup_param.secondary_type,
 			g_startup_param.server_ip,
 			g_startup_param.server_port,
 			g_startup_param.vhost_client);
-- 
2.18.0


